<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 
        CSP (Content Security Policy) Renforc√©e 
        - connect-src : Restreint aux serveurs de signalement PeerJS (*.peerjs.com) et scheme STUN.
        - script-src : 'unsafe-inline' n√©cessaire pour ce fichier unique.
        - CORRECTION : Utilisation de 'stun:' (scheme) pour √©viter l'erreur de syntaxe CSP sur les navigateurs r√©cents.
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; 
        img-src 'self' data: blob:; 
        media-src 'self' blob:;
        connect-src 'self' https://*.peerjs.com wss://*.peerjs.com https://unpkg.com https://cdn.tailwindcss.com https://cdnjs.cloudflare.com stun:;
    ">
    
    <title id="app-title">Partage P2P S√©curis√© (v2.4)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
        PeerJS 1.5.4 
        SRI Updated with computed hash provided
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"
            integrity="sha512-iFU+yF1keEaLDC9HEwPfLMSRaS0unBHE14GEgx6pQKJXjp5v0tvX8xpfp2lgJ62XEjbYp/M5C3CAmej/PWXMyA=="
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
            
    <!-- 
        CryptoJS 4.2.0 
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" 
            integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
            
    <!-- 
        JSZip 3.10.1
        SRI Updated with computed hash provided
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>

    <!-- Libs via unpkg (Pas de SRI possible sur @latest ou urls instables sans version pinning strict) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        #p2p-root { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; line-height: 1.5; isolation: isolate; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); opacity: 0; background-color: #10B981; color: white; padding: 10px 24px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.5); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); z-index: 2147483647; display: flex; align-items: center; gap: 8px; }
        .toast-visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .blur-text { filter: blur(6px); transition: filter 0.3s; user-select: none; }
        .blur-text:hover { filter: blur(3px); }
        .blur-text.revealed { filter: blur(0); user-select: all; }
        
        #p2p-root.theme-dark { --bg-main: #0F172A; --bg-card: #1E293B; --bg-header: #020617; --bg-input: #334155; --text-main: #F8FAFC; --text-muted: #94A3B8; --border: #334155; }
        #p2p-root.theme-light { --bg-main: #F8FAFC; --bg-card: #FFFFFF; --bg-header: #F1F5F9; --bg-input: #E2E8F0; --text-main: #1E293B; --text-muted: #64748B; --border: #CBD5E1; }
        #p2p-root .p2p-bg-main { background-color: var(--bg-main) !important; color: var(--text-main) !important; }
        #p2p-root .p2p-bg-card { background-color: var(--bg-card) !important; }
        #p2p-root .p2p-header { background-color: var(--bg-header) !important; border-bottom: 1px solid var(--border) !important; }
        #p2p-root .p2p-input { background-color: var(--bg-input) !important; color: var(--text-main) !important; border: 1px solid var(--border) !important; outline: none !important; }
        #p2p-root .p2p-border { border-color: var(--border) !important; }
        #p2p-root .p2p-text-main { color: var(--text-main) !important; }
        #p2p-root .p2p-text-muted { color: var(--text-muted) !important; }
        
        .modal-backdrop { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9) !important; display: none; justify-content: center; align-items: center; z-index: 2147483646 !important; backdrop-filter: blur(5px); }
        .modal-content { background: #1E293B; color: #F8FAFC; padding: 25px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; position: relative; z-index: 2147483647; text-align: left; }
        
        .chat-interface { display: flex; flex-direction: column; height: 500px; max-height: 70vh; }
        .chat-log-area { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .chat-input-area { padding: 0.75rem; background-color: var(--bg-header); border-top: 1px solid var(--border); }
        .msg-bubble { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 14px; position: relative; }
        .msg-text-copy { cursor: pointer; transition: opacity 0.2s; }
        .msg-text-copy:hover { opacity: 0.8; }
        
        .msg-sent { align-self: flex-end; background-color: rgba(16, 185, 129, 0.2); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.2); border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background-color: rgba(59, 130, 246, 0.2); color: #60A5FA; border: 1px solid rgba(59, 130, 246, 0.2); border-bottom-left-radius: 2px; }
        .msg-info { align-self: center; font-size: 11px; color: #94A3B8; background: rgba(148, 163, 184, 0.1); padding: 4px 10px; border-radius: 20px; margin: 5px 0; text-align: center; }
        .msg-error { align-self: center; font-size: 12px; color: #F87171; background: rgba(239, 68, 68, 0.1); padding: 6px 12px; border-radius: 20px; margin: 5px 0; text-align: center; border: 1px solid rgba(239, 68, 68, 0.2); }
        
        .download-btn {
            display: inline-flex; align-items: center; gap: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px; border-radius: 8px; margin-top: 6px;
            color: white !important; font-weight: bold; text-decoration: none !important;
            transition: background 0.2s; cursor: pointer; pointer-events: auto;
        }
        .download-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
        
        #reader video { border-radius: 8px; object-fit: cover; }
        .animate-lock { animation: pulse-lock 2s infinite; }
        @keyframes pulse-lock { 0%, 100% { transform: scale(1); color: #94a3b8; } 50% { transform: scale(1.15); color: #f59e0b; } }
        
        .help-section h4 { font-weight: bold; color: #34D399; margin-top: 20px; margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
        .help-section p { font-size: 14px; line-height: 1.6; margin-bottom: 8px; color: #CBD5E1; }
        
        /* New for Handshake */
        .verifying-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="m-0 p-4 flex items-center justify-center min-h-screen bg-gray-900 font-sans" onmousemove="resetInactivityTimer()" onkeypress="resetInactivityTimer()">

    <div id="p2p-root" class="w-full max-w-2xl theme-dark relative rounded-2xl overflow-hidden shadow-2xl p2p-bg-main transition-colors duration-300 border p2p-border">

        <div id="toast" class="toast-notification"><i data-lucide="check-circle" class="w-5 h-5"></i> <span id="toast-msg">Succ√®s</span></div>

        <!-- Verification Overlay -->
        <div id="verification-overlay" class="verifying-overlay hidden fade-in">
            <i data-lucide="shield-check" class="w-12 h-12 text-emerald-500 animate-bounce mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">V√©rification de s√©curit√©</h3>
            <p class="text-slate-400 text-sm">√âchange de cl√©s en cours...</p>
        </div>

        <!-- Modals -->
        <div id="scanner-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content flex flex-col items-center" onclick="event.stopPropagation()" style="max-width: 400px;">
                <div class="flex justify-between w-full mb-4"><h3 class="font-bold text-lg text-white">Scanner QR</h3><button onclick="stopScanner()"><i data-lucide="x"></i></button></div>
                <div id="reader" class="w-full bg-black rounded-lg overflow-hidden" style="min-height: 250px;"></div>
            </div>
        </div>

        <div id="qr-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content flex flex-col items-center bg-white text-slate-900" onclick="event.stopPropagation()" style="background: white; color: black; max-width: 350px;">
                <div class="flex justify-between w-full mb-4"><h3 class="font-bold text-lg">Mon Code</h3><button onclick="closeModals()"><i data-lucide="x"></i></button></div>
                <div id="qrcode" class="bg-white p-2 rounded border"></div>
                <p class="text-xs text-gray-500 mt-4 break-all font-mono bg-gray-100 p-3 rounded w-full border text-center" id="qr-text-display"></p>
            </div>
        </div>

        <div id="password-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-white" data-lang="passwordModalTitle">S√©curit√© Avanc√©e</h3>
                    <button onclick="closeModals()"><i data-lucide="x"></i></button>
                </div>
                <div class="bg-blue-500/10 border border-blue-500/30 p-3 rounded text-blue-200 text-xs mb-4">
                    <i data-lucide="shield-check" class="w-4 h-4 inline mr-1"></i> 
                    <strong>Niveau:</strong> PBKDF2-SHA256 (250k it√©rations).
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500/30 p-3 rounded text-yellow-400 text-xs mb-4">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> 
                    <strong data-lang="goldenRule">R√àGLE D'OR :</strong> <span data-lang="goldenRuleText">M√™me mot de passe requis des deux c√¥t√©s.</span>
                </div>
                <div id="password-strength-display" class="text-xs font-bold mb-2 h-4 transition-all text-right pr-1"></div>
                <div class="relative">
                    <i data-lucide="key" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                    <input type="password" id="modal-pw-input" class="w-full bg-slate-700 rounded-lg py-2 pl-10 pr-4 text-white border border-slate-600 focus:border-emerald-500 outline-none transition-colors" placeholder="..." data-lang-placeholder="passwordInputPlaceholder" oninput="checkPasswordStrength(this.value)">
                </div>
                <button onclick="savePassword()" id="btn-save-pw" class="mt-4 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg" data-lang="enableEncryption">Appliquer</button>
            </div>
        </div>

        <!-- Aide (DOM pur) -->
        <div id="help-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content help-section" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6 border-b border-slate-600 pb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-2xl text-white flex items-center gap-2"><i data-lucide="info" class="text-emerald-400"></i> <span data-lang="helpTitle">Info</span></h3>
                    </div>
                    <button onclick="closeModals()"><i data-lucide="x"></i></button>
                </div>
                <div id="help-dom-container" class="space-y-4"></div>
                <button onclick="closeModals()" class="mt-6 bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold w-full shadow-lg">OK</button>
            </div>
        </div>

        <!-- Header -->
        <div class="p-4 md:p-6 p2p-header flex justify-between items-center sticky top-0 z-10">
            <div>
                <h2 class="text-lg md:text-xl font-bold flex items-center gap-2 p2p-text-main">
                    <i data-lucide="shield-check" class="text-emerald-500 w-5 h-5"></i>
                    <span data-lang="title">Transfert S√©curis√©</span>
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openGithub()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted transition-colors" title="Code Source">
                    <i data-lucide="github" class="w-5 h-5"></i>
                </button>
                <button onclick="toggleLanguage()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted transition-colors flex items-center gap-1" title="Langue">
                    <i data-lucide="languages" class="w-5 h-5"></i> <span id="current-lang-display" class="text-xs font-bold">FR</span>
                </button>
                <button onclick="openHelp()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted" title="Aide"><i data-lucide="help-circle" class="w-5 h-5"></i></button>
                <button onclick="forceStop()" class="p-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white" title="Arr√™t"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted" title="Th√®me"><i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i></button>
                <div id="status-badge" class="hidden md:flex px-3 py-1.5 rounded-full text-xs font-bold border items-center gap-1.5"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-4 md:p-6 space-y-6 p2p-bg-main">
            
            <!-- ID -->
            <div id="section-identity" class="space-y-4 fade-in">
                <div class="flex gap-2">
                    <input type="text" id="my-id-input" disabled placeholder="G√©n√©ration ID..." class="w-full rounded-xl px-4 py-3 p2p-input text-sm" data-lang-placeholder="idPlaceholder">
                    <button onclick="initializePeer()" id="btn-init" class="px-4 md:px-6 py-3 rounded-xl font-bold bg-emerald-600 hover:bg-emerald-500 text-white flex items-center gap-2 shadow-lg whitespace-nowrap">
                        <i data-lucide="power" class="w-4 h-4"></i> <span data-lang="activate">Activer</span>
                    </button>
                </div>
                <label class="flex items-center gap-2 cursor-pointer w-fit text-sm p2p-text-muted">
                    <input type="checkbox" id="use-custom-name" class="w-4 h-4 accent-emerald-500 rounded" onchange="toggleCustomName()">
                    <span data-lang="useSecretName">Nom personnalis√©</span>
                </label>
                <div id="id-error" class="hidden text-sm text-red-400 p-3 bg-red-500/10 border border-red-500/20 rounded-lg"></div>
            </div>

            <!-- Connect -->
            <div id="section-connect" class="hidden space-y-6 pt-2 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="p-4 md:p-5 rounded-xl p2p-bg-card border p2p-border shadow-sm">
                        <h3 class="text-xs font-bold text-blue-500 mb-3 uppercase flex items-center gap-2"><i data-lucide="log-in" class="w-4 h-4"></i> <span data-lang="joinSomeone">Rejoindre</span></h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="remote-id-input" class="w-full rounded-lg px-3 py-2 text-sm p2p-input" placeholder="ID..." data-lang-placeholder="remoteIdPlaceholder">
                            <button onclick="startScanner()" class="p-2 bg-slate-500/20 hover:bg-slate-500/30 rounded-lg text-slate-300"><i data-lucide="scan-line" class="w-5 h-5"></i></button>
                        </div>
                        <button onclick="connectToPeer()" id="btn-connect" class="w-full bg-blue-600 hover:bg-blue-500 py-2.5 rounded-lg text-sm font-bold text-white shadow-lg">Connexion</button>
                    </div>

                    <div class="p-4 md:p-5 rounded-xl p2p-bg-card border p2p-border shadow-sm">
                        <h3 class="text-xs font-bold text-emerald-500 mb-3 uppercase flex items-center gap-2"><i data-lucide="fingerprint" class="w-4 h-4"></i> <span data-lang="yourId">Mon ID</span></h3>
                        <div class="flex items-center justify-between p2p-input p-2 rounded-lg border-dashed border p2p-border mb-2">
                            <code id="display-my-id" class="font-mono text-lg text-emerald-500 truncate blur-text mr-2 flex-grow select-none">...</code>
                            <div class="flex items-center gap-1 pl-2 border-l border-slate-500/20">
                                <button onclick="toggleIdReveal()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i id="eye-icon" data-lucide="eye" class="w-4 h-4"></i></button>
                                <button onclick="showQrCode()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i data-lucide="qr-code" class="w-4 h-4"></i></button>
                                <button onclick="copyId()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat/File -->
            <div id="section-sharing" class="hidden pt-2 fade-in">
                <div class="flex justify-between items-center mb-4 p-2 rounded-lg bg-slate-500/5 border border-slate-500/10">
                    <div class="text-xs font-bold text-emerald-500 flex items-center gap-2 pl-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> <span id="connected-peer-name">...</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <button onclick="openPasswordModal()" id="btn-lock" class="p-2 rounded-lg hover:bg-slate-500/20 text-slate-400 transition-colors relative animate-lock" title="Mot de passe"><i data-lucide="lock" class="w-4 h-4"></i></button>
                        <div class="w-px h-4 bg-slate-500/20"></div>
                        <button onclick="document.getElementById('file-input-chat').click()" class="p-2 rounded-lg hover:bg-slate-500/20 p2p-text-muted" title="Fichier"><i data-lucide="paperclip" class="w-4 h-4"></i></button>
                        <input type="file" id="file-input-chat" class="hidden" multiple onchange="handleFileSelect(this)">
                        <input type="file" id="file-input-folder" class="hidden" webkitdirectory directory onchange="handleFileSelect(this)">
                        <button onclick="document.getElementById('file-input-folder').click()" class="p-2 rounded-lg hover:bg-slate-500/20 p2p-text-muted" title="Dossier"><i data-lucide="folder-up" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="chat-interface p2p-bg-card rounded-xl border p2p-border overflow-hidden shadow-lg">
                    <div id="chat-log" class="chat-log-area p2p-bg-main">
                        <div class="msg-info flex flex-col gap-1">
                            <span data-lang="connectedMsg">Connexion √©tablie.</span>
                            <span id="security-status-container" class="flex items-center justify-center gap-1 text-[10px]"></span>
                        </div>
                    </div>
                    <div class="chat-input-area p2p-header flex gap-2 items-center">
                        <input type="text" id="msg-input" class="flex-grow rounded-full px-4 py-2.5 text-sm p2p-input border-none focus:ring-2 focus:ring-emerald-500 shadow-inner" placeholder="..." data-lang-placeholder="chatPlaceholder" onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="p-2.5 rounded-full bg-emerald-600 text-white hover:bg-emerald-500 transition-transform active:scale-90 shadow-md"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
                
                <div id="file-status-area" class="hidden mt-2 p-2 bg-slate-500/10 rounded text-xs p2p-text-muted flex justify-between items-center">
                    <span id="file-status-text">Pr√©paration...</span>
                    <div id="file-progress" class="hidden w-4 h-4 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let peer = null, conn = null, myId = null;
        let html5QrCode = null, isScannerRunning = false;
        let isDark = true, currentLang = 'fr', sharedPassword = "";
        let retryCount = 0; const MAX_RETRIES = 3; let initTimeout = null;
        let messageCount = 0; let lastMessageTime = Date.now();
        let inactivityTimer = null;
        // Handshake state
        let isHandshakeComplete = false; 
        let handshakeSessionToken = null; // Token for the current session (Nonce)

        const TRANSLATIONS = {
            fr: {
                title: "Transfert S√©curis√©", useSecretName: "Nom personnalis√©", activate: "Activer", joinSomeone: "Rejoindre", connect: "Connexion",
                yourId: "Mon ID", shareIdInstruction: "Partagez ceci.", helpTitle: "Aide & S√©curit√©", idPlaceholder: "G√©n√©ration ID...", remoteIdPlaceholder: "ID de l'ami",
                statusDisconnected: "D√©connect√©", statusOnlineWaiting: "En ligne (Pr√™t)", statusConnected: "Connect√©", idTakenError: "Nom d√©j√† pris !",
                connectedMsg: "Canal ouvert.", toastCopied: "Copi√© !", chatPlaceholder: "Message...", 
                passwordModalTitle: "S√©curiser la conversation", passwordInputPlaceholder: "Mot de passe commun...", enableEncryption: "Activer la s√©curit√©", 
                securityEncrypted: "üîí S√©curis√© (AES-256-SHA256)", securityUnencrypted: "‚ö†Ô∏è Non s√©curis√© (Clair)", decryptionFail: "‚õî Erreur cl√©",
                encryptedMsgReceived: "üîí Message chiffr√©.", fileReceived: "Fichier re√ßu : ", fileSent: "Fichier envoy√©.",
                folderSent: "Dossier envoy√©.", fileBig: "‚ö†Ô∏è Limite crypto JS (~50Mo).", msgRateLimit: "Trop rapide ! Ralentissez.",
                errNetwork: "Erreur r√©seau", errPeerUnavailable: "Pair introuvable", errUnknown: "Erreur inconnue",
                handshakeFail: "‚õî Mot de passe incorrect ! D√©connexion.",
                helpContent: [
                    { tag: 'h4', class: 'text-emerald-400 font-bold mb-2', text: 'üöÄ Comment √ßa marche ?' },
                    { tag: 'p', class: 'mb-4 text-sm', text: 'Connexion directe (P2P). V2.4 : SRI actif et gestion s√©curis√©e des mots de passe.' },
                    { tag: 'h4', class: 'text-emerald-400 font-bold mb-2', text: 'üîí S√©curit√© (V2.4 Hardened)' },
                    { tag: 'p', class: 'mb-4 text-sm', text: 'AES-256 + PBKDF2 (SHA256, 250k it√©rations). Protection anti-rejeu par Nonce al√©atoire.' },
                    { tag: 'h4', class: 'text-amber-400 font-bold mb-2', text: '‚ö†Ô∏è Fichiers' },
                    { tag: 'p', class: 'text-sm', text: 'Le chiffrement se fait en m√©moire. Les fichiers >50Mo peuvent faire planter l\'onglet.' }
                ],
                pwWeak: "Faible", pwMedium: "Moyen", pwStrong: "Fort", pwExcellent: "Excellent",
                goldenRule: "IMPORTANT :", goldenRuleText: "Vous devez convenir du m√™me mot de passe."
            },
            en: {
                title: "Secure Transfer", useSecretName: "Custom Name", activate: "Activate", joinSomeone: "Join", connect: "Connect",
                yourId: "My ID", shareIdInstruction: "Share this.", helpTitle: "Help & Security", idPlaceholder: "Generating ID...", remoteIdPlaceholder: "Friend's ID",
                statusDisconnected: "Disconnected", statusOnlineWaiting: "Online", statusConnected: "Connected", idTakenError: "Name taken!",
                connectedMsg: "Channel open.", toastCopied: "Copied!", chatPlaceholder: "Message...", 
                passwordModalTitle: "Secure Conversation", passwordInputPlaceholder: "Shared password...", enableEncryption: "Enable Security", 
                securityEncrypted: "üîí Secured (AES-256-SHA256)", securityUnencrypted: "‚ö†Ô∏è Unsecured (Cleartext)", decryptionFail: "‚õî Key Error",
                encryptedMsgReceived: "üîí Encrypted message.", fileReceived: "File received: ", fileSent: "File sent.",
                folderSent: "Folder sent.", fileBig: "‚ö†Ô∏è JS Crypto Limit (~50MB).", msgRateLimit: "Slow down!",
                errNetwork: "Network Error", errPeerUnavailable: "Peer unavailable", errUnknown: "Unknown error",
                handshakeFail: "‚õî Wrong Password! Disconnecting.",
                helpContent: [
                    { tag: 'h4', class: 'text-emerald-400 font-bold mb-2', text: 'üöÄ How it works?' },
                    { tag: 'p', class: 'mb-4 text-sm', text: 'Direct P2P. V2.4: Active SRI and secure password handling.' },
                    { tag: 'h4', class: 'text-emerald-400 font-bold mb-2', text: 'üîí Security (V2.4 Hardened)' },
                    { tag: 'p', class: 'mb-4 text-sm', text: 'AES-256 + PBKDF2 (SHA256, 250k iters). Anti-replay protection via random Nonce.' },
                    { tag: 'h4', class: 'text-amber-400 font-bold mb-2', text: '‚ö†Ô∏è Files' },
                    { tag: 'p', class: 'text-sm', text: 'Encryption happens in memory. Files >50MB may crash the tab.' }
                ],
                pwWeak: "Weak", pwMedium: "Medium", pwStrong: "Strong", pwExcellent: "Excellent",
                goldenRule: "IMPORTANT:", goldenRuleText: "You must agree on the exact same password."
            }
        };

        // --- DOM HELP BUILDER ---
        function renderHelp() {
            const container = document.getElementById('help-dom-container');
            if(!container) return;
            container.innerHTML = '';
            const content = TRANSLATIONS[currentLang].helpContent;
            content.forEach(item => {
                const el = document.createElement(item.tag);
                el.className = item.class;
                el.innerHTML = item.text;
                container.appendChild(el);
            });
        }

        function openGithub() { window.open("https://github.com/anonymousxptdr360/P2P-Encrypted-Chat", "_blank", "noopener,noreferrer"); }

        function checkPasswordStrength(pw) {
            const display = document.getElementById('password-strength-display');
            const t = TRANSLATIONS[currentLang];
            if (!pw) { display.innerText = ""; return; }
            let score = 0;
            if (pw.length >= 12) score++; if (pw.length >= 16) score++;
            if (/[A-Z]/.test(pw)) score++; if (/[0-9]/.test(pw)) score++; if (/[^A-Za-z0-9]/.test(pw)) score++;
            if (pw.length < 8) { display.innerText = `üî¥ ${t.pwWeak}`; display.className = "text-xs font-bold mb-2 h-4 text-right pr-1 text-red-500"; return; }
            switch (score) {
                case 0: case 1: display.innerText = `üî¥ ${t.pwWeak}`; display.className = "text-xs font-bold mb-2 h-4 text-right pr-1 text-red-500"; break;
                case 2: case 3: display.innerText = `üü† ${t.pwMedium}`; display.className = "text-xs font-bold mb-2 h-4 text-right pr-1 text-orange-400"; break;
                case 4: display.innerText = `üü¢ ${t.pwStrong}`; display.className = "text-xs font-bold mb-2 h-4 text-right pr-1 text-emerald-400"; break;
                case 5: display.innerText = `üöÄ ${t.pwExcellent}`; display.className = "text-xs font-bold mb-2 h-4 text-right pr-1 text-emerald-300"; break;
            }
        }

        // --- SECURE CRYPTO V2.1 (SHA256 + 250k) ---
        const deriveKeys = (password, salt) => {
            const kdf = CryptoJS.PBKDF2(password, salt, { keySize: 512/32, iterations: 250000, hasher: CryptoJS.algo.SHA256 });
            const aesKey = CryptoJS.lib.WordArray.create(kdf.words.slice(0, 8));
            const hmacKey = CryptoJS.lib.WordArray.create(kdf.words.slice(8, 16));
            return { aesKey, hmacKey };
        };

        const encryptData = (data, password) => {
            try {
                const salt = CryptoJS.lib.WordArray.random(128/8);
                const iv = CryptoJS.lib.WordArray.random(128/8);
                const keys = deriveKeys(password, salt);
                const encrypted = CryptoJS.AES.encrypt(data, keys.aesKey, { iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC });
                const msgToSign = salt.clone().concat(iv).concat(encrypted.ciphertext);
                const hmac = CryptoJS.HmacSHA256(msgToSign, keys.hmacKey);
                return salt.toString() + ":" + iv.toString() + ":" + hmac.toString() + ":" + encrypted.ciphertext.toString();
            } catch (e) { console.error(e); return null; }
        };

        const decryptData = (cipherPayload, password) => {
            try {
                const parts = cipherPayload.split(':');
                if (parts.length !== 4) return null;
                const salt = CryptoJS.enc.Hex.parse(parts[0]);
                const iv = CryptoJS.enc.Hex.parse(parts[1]);
                const receivedHmac = parts[2];
                const ciphertext = CryptoJS.enc.Hex.parse(parts[3]);
                const keys = deriveKeys(password, salt);
                const msgToVerify = salt.clone().concat(iv).concat(ciphertext);
                const computedHmac = CryptoJS.HmacSHA256(msgToVerify, keys.hmacKey).toString();
                if (computedHmac !== receivedHmac) return null;
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, keys.aesKey, { iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) { return null; }
        };

        // --- LOGIC ---
        function initUI() {
            updateTheme(true);
            lucide.createIcons();
            applyLanguage('fr');
            updateStatusBadge('disconnect');
        }

        function initializePeer() {
            if (typeof Peer === 'undefined') return alert("Erreur CDN: PeerJS non charg√©.");
            const btn = document.getElementById('btn-init');
            const custom = document.getElementById('use-custom-name').checked ? document.getElementById('my-id-input').value.trim() : null;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader" class="animate-spin"></i>`;
            lucide.createIcons();

            peer = new Peer(custom, {
                debug: 1,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('display-my-id').innerText = id;
                document.getElementById('section-identity').classList.add('hidden');
                document.getElementById('section-connect').classList.remove('hidden');
                updateStatusBadge('waiting');
                btn.innerHTML = "Activer";
            });
            peer.on('connection', (c) => setupConn(c));
            peer.on('error', (err) => {
                btn.disabled = false;
                btn.innerHTML = "Activer";
                document.getElementById('id-error').classList.remove('hidden');
                document.getElementById('id-error').innerText = err.type || "Erreur";
            });
        }

        function connectToPeer() {
            const target = document.getElementById('remote-id-input').value.trim();
            if(!target) return;
            const btn = document.getElementById('btn-connect');
            btn.innerText = "...";
            btn.disabled = true;
            setupConn(peer.connect(target));
            setTimeout(() => {
                if(!conn || !conn.open) {
                    btn.innerText = "R√©essayer";
                    btn.disabled = false;
                }
            }, 5000);
        }

        function setupConn(c) {
            conn = c;
            // Reset state
            isHandshakeComplete = !sharedPassword; // If no password, handshake is auto-complete
            
            conn.on('open', () => {
                document.getElementById('section-connect').classList.add('hidden');
                document.getElementById('section-sharing').classList.remove('hidden');
                document.getElementById('connected-peer-name').innerText = conn.peer;
                
                if(sharedPassword) {
                    // Start Handshake
                    document.getElementById('verification-overlay').classList.remove('hidden');
                    // GENERATE RANDOM NONCE
                    handshakeSessionToken = CryptoJS.lib.WordArray.random(16).toString();
                    // Send Challenge
                    setTimeout(() => {
                        sendPayload({ type: 'handshake-challenge', token: handshakeSessionToken }, null, false, true);
                    }, 500);
                } else {
                    // No password - Open immediately
                    updateStatusBadge('connect');
                }
            });
            conn.on('data', (d) => receiveData(d));
            conn.on('close', () => { alert("D√©connect√©"); location.reload(); });
        }

        function sendMessage() {
            if(!isHandshakeComplete && sharedPassword) return; // Block
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if(!txt) return;

            const now = Date.now();
            if (now - lastMessageTime < 200) {
                messageCount++;
                if (messageCount > 5) {
                    alert(TRANSLATIONS[currentLang].msgRateLimit);
                    return;
                }
            } else {
                messageCount = 0;
            }
            lastMessageTime = now;

            sendPayload({ type: 'text', content: txt }, txt, false);
            inp.value = '';
        }

        function sendPayload(obj, displayMsg, isFile, isSystem=false) {
            let payload = JSON.stringify(obj);
            let isEncrypted = false;
            if (sharedPassword) {
                setTimeout(() => {
                    const enc = encryptData(payload, sharedPassword);
                    if(enc) {
                        payload = enc;
                        isEncrypted = true;
                    }
                    dispatch();
                }, 10);
            } else {
                dispatch();
            }

            function dispatch() {
                if (conn && conn.open) {
                    conn.send({ data: payload, encrypted: isEncrypted });
                    if(displayMsg) addMsg(displayMsg, 'sent', false);
                }
            }
        }

        function receiveData(packet) {
            setTimeout(() => {
                let raw = packet.data;
                // 1. Decrypt
                if(packet.encrypted) {
                    if(!sharedPassword) {
                        // We received encrypted data but have no password set -> Error
                        if(!isHandshakeComplete) closeConnWithError(); 
                        else addMsg(TRANSLATIONS[currentLang].encryptedMsgReceived, 'info');
                        return;
                    }
                    const dec = decryptData(raw, sharedPassword);
                    if(!dec) {
                        // Decryption failed (Wrong password)
                        if(!isHandshakeComplete) closeConnWithError(); // Fail handshake
                        else addMsg(TRANSLATIONS[currentLang].decryptionFail, 'error');
                        return;
                    }
                    raw = dec;
                }

                // 2. Parse
                try {
                    const p = JSON.parse(raw);
                    
                    // --- HANDSHAKE LOGIC ---
                    if (p.type === 'handshake-challenge') {
                        // Received challenge. Echo back to prove we could decrypt it.
                        // We do NOT check against our token (we didn't send this one), we just ACK it.
                        sendPayload({ type: 'handshake-ack', token: p.token }, null, false, true);
                        
                        // If we could decrypt the challenge, it means the sender has the correct key (integrity check passed).
                        // So we are safe to complete handshake on our side too.
                        completeHandshake();
                        return;
                    }
                    if (p.type === 'handshake-ack') {
                        // Received ACK. Verify it matches the token WE sent.
                        if (p.token === handshakeSessionToken) {
                            completeHandshake();
                        } else {
                            console.error("Handshake token mismatch");
                            closeConnWithError();
                        }
                        return;
                    }

                    if (!isHandshakeComplete && sharedPassword) return; // Ignore other data until handshake done

                    // --- APP LOGIC ---
                    if(p.type === 'text') addMsg(p.content, 'received', false);
                    if(p.type === 'file') {
                        // Decode Base64
                        const parts = p.content.split(';base64,');
                        const contentType = parts[0].split(':')[1];
                        const b64 = parts[1];
                        const byteCharacters = atob(b64);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], {type: contentType});
                        const url = URL.createObjectURL(blob);
                        
                        const safeName = p.name.replace(/[^a-zA-Z0-9._-]/g, '_').substring(0, 255);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = safeName;
                        link.className = "download-btn";
                        link.textContent = `üì• ${safeName}`;
                        link.onclick = (e) => { e.stopPropagation(); };
                        
                        addMsg(link, 'received', true);
                    }
                } catch(e) { console.error(e); }
            }, 10);
        }

        function completeHandshake() {
            if(isHandshakeComplete) return;
            isHandshakeComplete = true;
            document.getElementById('verification-overlay').classList.add('hidden');
            updateStatusBadge('connect');
            showToast("üîí S√©curit√© v√©rifi√©e");
        }

        function closeConnWithError() {
            alert(TRANSLATIONS[currentLang].handshakeFail);
            conn.close();
            location.reload();
        }

        async function handleFileSelect(input) {
            const files = Array.from(input.files);
            if(files.length === 0) return;
            
            const statusArea = document.getElementById('file-status-area');
            const statusText = document.getElementById('file-status-text');
            const loader = document.getElementById('file-progress');
            
            statusArea.classList.remove('hidden');
            loader.classList.remove('hidden');

            let totalSize = 0;
            files.forEach(f => totalSize += f.size);
            if(totalSize > 50 * 1024 * 1024) {
                if(!confirm("Attention: >50Mo peut ralentir le navigateur (Encryption JS). Continuer ?")) {
                    statusArea.classList.add('hidden');
                    input.value='';
                    return;
                }
            }

            try {
                const isMultiple = files.length > 1;
                const isFolder = files.length > 0 && files[0].webkitRelativePath !== "";
                
                if (isMultiple || isFolder) {
                    statusText.innerText = `Zip...`;
                    const zip = new JSZip();
                    for (let f of files) zip.file(f.webkitRelativePath || f.name, f);
                    const content = await zip.generateAsync({type:"base64"});
                    sendPayload({ type: 'file', name: `Archive_${Date.now()}.zip`, content: 'data:application/zip;base64,' + content, mime: 'application/zip' }, TRANSLATIONS[currentLang].folderSent, false);
                } else {
                    const f = files[0];
                    statusText.innerText = `Envoi...`;
                    const base64 = await readFileAsDataURL(f);
                    sendPayload({ type: 'file', name: f.name, content: base64, mime: f.type || 'application/octet-stream' }, `${TRANSLATIONS[currentLang].fileSent} ${f.name}`, false);
                }
            } catch(e) {
                alert("Erreur: " + e);
            }
            statusArea.classList.add('hidden');
            input.value = '';
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function addMsg(content, type, isElement = false) {
            const log = document.getElementById('chat-log');
            const d = document.createElement('div');
            if(type==='info') {
                d.className='msg-info';
                d.innerText=content;
            } else if(type==='error') {
                d.className='msg-error';
                d.innerText=content;
            } else {
                d.className = `msg-bubble ${type==='sent'?'msg-sent':'msg-received'} ${!isElement ? 'msg-text-copy' : ''}`;
                if(isElement) d.appendChild(content);
                else d.innerText = content;
                
                if(!isElement) d.onclick = () => { secureCopy(d.innerText, TRANSLATIONS[currentLang].toastCopied); };
            }
            log.appendChild(d);
            log.scrollTop=log.scrollHeight;
        }

        function updateStatusBadge(s) {
            const b = document.getElementById('status-badge');
            if(!b) return;
            b.innerHTML = '';
            const t = TRANSLATIONS[currentLang];
            const dot = document.createElement('span');
            dot.className = "w-2 h-2 rounded-full inline-block mr-2";
            const txt = document.createElement('span');
            
            if(s === 'connect') {
                dot.classList.add('bg-emerald-500');
                txt.textContent = t.statusConnected;
            } else if(s === 'waiting') {
                dot.classList.add('bg-yellow-500');
                txt.textContent = t.statusOnlineWaiting;
            } else {
                dot.classList.add('bg-red-500');
                txt.textContent = t.statusDisconnected;
            }
            b.appendChild(dot);
            b.appendChild(txt);
        }

        function updateSecurityStatusDisplay() {
            const container = document.getElementById('security-status-container');
            if(!container) return;
            container.innerHTML = '';
            const t = TRANSLATIONS[currentLang];
            const icon = document.createElement('i');
            const text = document.createElement('span');
            const btn = document.getElementById('btn-lock');

            if (sharedPassword) {
                icon.setAttribute('data-lucide', 'lock');
                icon.className = "w-3 h-3 text-emerald-500 mr-1";
                text.textContent = t.securityEncrypted;
                text.className = "text-emerald-500";
                btn.classList.remove('animate-lock');
                btn.classList.add('text-emerald-500');
            } else {
                icon.setAttribute('data-lucide', 'unlock');
                icon.className = "w-3 h-3 text-amber-500 mr-1";
                text.textContent = t.securityUnencrypted;
                text.className = "text-amber-500";
                btn.classList.add('animate-lock');
                btn.classList.remove('text-emerald-500');
            }
            container.appendChild(icon);
            container.appendChild(text);
            lucide.createIcons();
        }

        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const k = el.getAttribute('data-lang');
                if(TRANSLATIONS[lang][k]) el.textContent=TRANSLATIONS[lang][k];
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const k = el.getAttribute('data-lang-placeholder');
                if(TRANSLATIONS[lang][k]) el.placeholder=TRANSLATIONS[lang][k];
            });
            renderHelp();
            document.getElementById('current-lang-display').textContent = lang.toUpperCase();
            updateSecurityStatusDisplay();
        }

        function updateTheme(forceDark = null) {
            const root = document.getElementById('p2p-root');
            const icon = document.getElementById('theme-icon');
            if(forceDark !== null) isDark = forceDark;
            else isDark = !isDark;

            if(isDark) {
                root.classList.add('theme-dark');
                root.classList.remove('theme-light');
                if(icon) icon.setAttribute('data-lucide','moon');
            } else {
                root.classList.add('theme-light');
                root.classList.remove('theme-dark');
                if(icon) icon.setAttribute('data-lucide','sun');
            }
            lucide.createIcons();
        }

        function toggleLanguage() { applyLanguage(currentLang === 'fr' ? 'en' : 'fr'); }
        function toggleTheme() { updateTheme(); }
        function forceStop() { if(confirm("Reload?")) location.reload(); }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText=m;
            t.classList.add('toast-visible');
            setTimeout(()=>t.classList.remove('toast-visible'),2000);
        }

        function secureCopy(t, m) {
            if(navigator.clipboard) navigator.clipboard.writeText(t).then(()=>showToast(m));
        }

        // Modals / Reset Handshake on password change
        function openHelp() { document.getElementById('help-modal').style.display='flex'; applyLanguage(currentLang); }
        function openPasswordModal() { document.getElementById('password-modal').style.display='flex'; document.getElementById('modal-pw-input').value=sharedPassword; }

        function savePassword() {
            const inputVal = document.getElementById('modal-pw-input').value.trim();
            // Check if connected before changing password
            if (conn && conn.open) {
                if(!confirm("Changer le mot de passe pendant une connexion n√©cessite un rechargement pour garantir la s√©curit√©. Continuer ?")) return;
                conn.close();
                location.reload();
                return;
            }
            sharedPassword = inputVal;
            if(sharedPassword) {
                showToast("Mot de passe d√©fini");
            } else {
                showToast("Mot de passe retir√©");
            }
            updateSecurityStatusDisplay();
            document.getElementById('password-strength-display').innerText="";
            closeModals();
        }

        function closeModals(e) {
            if(e && e.target.classList.contains('modal-content')) return;
            document.querySelectorAll('.modal-backdrop').forEach(el => el.style.display='none');
            if(html5QrCode && isScannerRunning) {
                html5QrCode.stop().then(()=>{ isScannerRunning=false; html5QrCode.clear(); }).catch(()=>{});
            }
        }

        // QR
        function showQrCode() {
            const id = document.getElementById('display-my-id').innerText;
            if(id==='...') return;
            document.getElementById('qrcode').innerHTML='';
            new QRCode(document.getElementById('qrcode'), {text:id, width:128, height:128});
            document.getElementById('qr-text-display').innerText=id;
            document.getElementById('qr-modal').style.display='flex';
        }

        function startScanner() {
            document.getElementById('scanner-modal').style.display='flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:{width:250, height:250}}, (txt)=>{
                document.getElementById('remote-id-input').value=txt;
                showToast("QR OK");
                stopScanner();
            }).then(() => isScannerRunning=true).catch(e => {
                alert("Cam√©ra erreur: "+e);
                closeModals();
            });
        }

        function stopScanner() { closeModals(); }
        
        function toggleCustomName() {
            const c=document.getElementById('use-custom-name');
            document.getElementById('my-id-input').disabled=!c.checked;
            if(!c.checked) document.getElementById('my-id-input').value='';
        }
        
        function toggleIdReveal() {
            document.getElementById('display-my-id').classList.toggle('revealed');
            lucide.createIcons();
        }
        
        function copyId() {
            const t = document.getElementById('display-my-id').innerText;
            if(t!=='...') secureCopy(t, TRANSLATIONS[currentLang].toastCopied);
        }
        
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (conn && conn.open) {
                    alert("D√©connexion pour inactivit√© (30 min)");
                    conn.close();
                    location.reload();
                }
            }, 30 * 60 * 1000);
        }

        initUI();
    </script>
</body>
</html>