<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Partage S√©curis√© P2P</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* === ISOLATION CSS === */
        #p2p-root {
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            line-height: 1.5;
            isolation: isolate;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast */
        .toast-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); opacity: 0;
            background-color: #10B981; color: white; padding: 10px 24px; border-radius: 50px;
            font-size: 14px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); z-index: 2147483647; display: flex; align-items: center; gap: 8px;
        }
        .toast-visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* Flou ID */
        .blur-text { filter: blur(6px); transition: filter 0.3s; user-select: none; }
        .blur-text:hover { filter: blur(3px); }
        .blur-text.revealed { filter: blur(0); user-select: all; }

        /* === TH√àMES === */
        #p2p-root.theme-dark {
            --bg-main: #0F172A; --bg-card: #1E293B; --bg-header: #020617; --bg-input: #334155;
            --text-main: #F8FAFC; --text-muted: #94A3B8; --border: #334155;
        }
        #p2p-root.theme-light {
            --bg-main: #F8FAFC; --bg-card: #FFFFFF; --bg-header: #F1F5F9; --bg-input: #E2E8F0;
            --text-main: #1E293B; --text-muted: #64748B; --border: #CBD5E1;
        }

        /* Utility Classes forced */
        #p2p-root .p2p-bg-main { background-color: var(--bg-main) !important; color: var(--text-main) !important; }
        #p2p-root .p2p-bg-card { background-color: var(--bg-card) !important; }
        #p2p-root .p2p-header { background-color: var(--bg-header) !important; border-bottom: 1px solid var(--border) !important; }
        #p2p-root .p2p-input { background-color: var(--bg-input) !important; color: var(--text-main) !important; border: 1px solid var(--border) !important; outline: none !important; }
        #p2p-root .p2p-border { border-color: var(--border) !important; }
        #p2p-root .p2p-text-main { color: var(--text-main) !important; }
        #p2p-root .p2p-text-muted { color: var(--text-muted) !important; }
        
        /* Modals (Fixed & High Z-Index) */
        .modal-backdrop { 
            position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9) !important; 
            display: none; justify-content: center; align-items: center; 
            z-index: 2147483646 !important; backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: #1E293B; color: #F8FAFC; padding: 25px; border-radius: 16px; 
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid #334155;
            position: relative; z-index: 2147483647; text-align: left;
        }
        
        /* Chat Interface Layout */
        .chat-interface { display: flex; flex-direction: column; height: 500px; max-height: 70vh; }
        .chat-log-area { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .chat-input-area { padding: 0.75rem; background-color: var(--bg-header); border-top: 1px solid var(--border); }
        
        /* Messages */
        .msg-bubble { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 14px; position: relative; cursor: pointer; }
        .msg-sent { align-self: flex-end; background-color: rgba(16, 185, 129, 0.2); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.2); border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background-color: rgba(59, 130, 246, 0.2); color: #60A5FA; border: 1px solid rgba(59, 130, 246, 0.2); border-bottom-left-radius: 2px; }
        .msg-info { align-self: center; font-size: 11px; color: #94A3B8; background: rgba(148, 163, 184, 0.1); padding: 4px 10px; border-radius: 20px; margin: 5px 0; text-align: center; }
        .msg-error { align-self: center; font-size: 12px; color: #F87171; background: rgba(239, 68, 68, 0.1); padding: 6px 12px; border-radius: 20px; margin: 5px 0; text-align: center; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* Scanner */
        #reader video { border-radius: 8px; object-fit: cover; }

        /* Help Styles */
        .help-section h4 { font-weight: bold; color: #34D399; margin-top: 20px; margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
        .help-section p, .help-section li { font-size: 14px; line-height: 1.6; margin-bottom: 8px; color: #CBD5E1; }
        .help-section ul, .help-section ol { padding-left: 20px; margin-bottom: 12px; }
        .help-section ul { list-style-type: disc; }
        .help-section ol { list-style-type: decimal; }
        .help-section strong { color: #F8FAFC; }
        .highlight-box { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); padding: 10px; border-radius: 8px; color: #FDE047; font-size: 13px; margin: 10px 0; }
    </style>
</head>
<body class="m-0 p-4 flex items-center justify-center min-h-screen bg-gray-900 font-sans">

    <!-- Wrapper Principal -->
    <div id="p2p-root" class="w-full max-w-2xl theme-dark relative rounded-2xl overflow-hidden shadow-2xl p2p-bg-main transition-colors duration-300 border p2p-border">

        <!-- Toast -->
        <div id="toast" class="toast-notification">
            <i data-lucide="check-circle" class="w-5 h-5"></i> <span id="toast-msg">Succ√®s</span>
        </div>

        <!-- Modal Scanner -->
        <div id="scanner-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content flex flex-col items-center" onclick="event.stopPropagation()" style="max-width: 400px;">
                <div class="flex justify-between w-full mb-4">
                    <h3 class="font-bold text-lg text-white">Scanner un QR Code</h3>
                    <button onclick="stopScanner()" class="text-gray-400 hover:text-red-400"><i data-lucide="x"></i></button>
                </div>
                <div id="reader" class="w-full bg-black rounded-lg overflow-hidden" style="min-height: 250px;"></div>
                <p class="text-xs text-gray-400 mt-4">Pointez la cam√©ra vers l'√©cran de votre ami.</p>
            </div>
        </div>

        <!-- Modal QR Code -->
        <div id="qr-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content flex flex-col items-center bg-white text-slate-900" onclick="event.stopPropagation()" style="background: white; color: black; max-width: 350px;">
                <div class="flex justify-between w-full mb-4">
                    <h3 class="font-bold text-lg">Mon Code</h3>
                    <button onclick="closeModals()" class="text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
                </div>
                <div id="qrcode" class="bg-white p-2 rounded border"></div>
                <p class="text-xs text-gray-500 mt-4 break-all font-mono bg-gray-100 p-3 rounded w-full border text-center" id="qr-text-display"></p>
            </div>
        </div>

        <!-- Modal Mot de Passe -->
        <div id="password-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-white" data-lang="passwordModalTitle">Mot de passe (Secret partag√©)</h3>
                    <button onclick="closeModals()" class="text-gray-400 hover:text-red-400"><i data-lucide="x"></i></button>
                </div>
                <div class="highlight-box">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> 
                    <strong data-lang="goldenRule">R√àGLE D'OR :</strong> <span data-lang="goldenRuleText">Vous et votre ami devez entrer EXACTEMENT le m√™me mot de passe.</span>
                </div>
                <p class="text-sm text-gray-400 mb-4" data-lang="passwordMismatchInfo">Si les mots de passe sont diff√©rents, les messages appara√Ætront comme "Ind√©chiffrables".</p>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                    <input type="password" id="modal-pw-input" class="w-full bg-slate-700 rounded-lg py-2 pl-10 pr-4 text-white border border-slate-600 focus:border-emerald-500 outline-none" placeholder="Mot de passe commun..." data-lang-placeholder="passwordInputPlaceholder">
                </div>
                <button onclick="savePassword()" class="mt-4 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg" data-lang="enableEncryption">Activer le chiffrement</button>
            </div>
        </div>

        <!-- Modal Aide (D√©taill√©e & Bilingue) -->
        <div id="help-modal" class="modal-backdrop fade-in" onclick="closeModals(event)">
            <div class="modal-content help-section" onclick="event.stopPropagation()">
                
                <div class="flex justify-between items-center mb-6 border-b border-slate-600 pb-4">
                    <h3 class="font-bold text-2xl text-white flex items-center gap-2">
                        <i data-lucide="info" class="text-emerald-400"></i> <span data-lang="helpTitle">Comment √ßa marche ?</span>
                    </h3>
                    <button onclick="closeModals()" class="p-2 rounded-full hover:bg-slate-700 text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                
                <!-- Contenu Fran√ßais -->
                <div id="help-fr">
                    <h4>üöÄ Principe de Fonctionnement</h4>
                    <p>Ce syst√®me connecte deux appareils en direct (P2P). <strong>Aucun serveur ne stocke vos donn√©es.</strong></p>
                    <h4>üîí S√©curit√© & Chiffrement (Important)</h4>
                    <div class="highlight-box">
                        ‚ö†Ô∏è <strong>ATTENTION AUX MOTS DE PASSE</strong><br>
                        Si "A" met le mot de passe "123" et "B" met "456", ils ne pourront PAS se lire. Le syst√®me vous avertira par un message rouge "√âchec d√©chiffrement".
                    </div>
                    <ul>
                        <li><strong>Sans mot de passe :</strong> La connexion est directe mais non chiffr√©e par vos soins.</li>
                        <li><strong>Avec mot de passe :</strong> En cliquant sur le cadenas <i data-lucide="lock" class="w-3 h-3 inline text-yellow-500"></i>, vous activez le chiffrement <strong>AES-256</strong>.</li>
                    </ul>
                    <h4>üõ†Ô∏è Guide Rapide</h4>
                    <ol>
                        <li>Cliquez sur <strong>"Activer"</strong>.</li>
                        <li>Donnez votre ID √† l'ami (ou scannez son QR Code).</li>
                        <li>Connectez-vous.</li>
                    </ol>
                    <button onclick="closeModals()" class="mt-8 bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-emerald-500 w-full shadow-lg">J'ai tout compris !</button>
                </div>

                <!-- Contenu Anglais (Cach√© par d√©faut) -->
                <div id="help-en" class="hidden">
                    <h4>üöÄ How it works</h4>
                    <p>This system connects two devices directly (P2P). <strong>No server stores your data.</strong></p>
                    <h4>üîí Security & Encryption (Important)</h4>
                    <div class="highlight-box">
                        ‚ö†Ô∏è <strong>PASSWORD WARNING</strong><br>
                        If "A" sets password "123" and "B" sets "456", they CANNOT read each other. You will see a red "Decryption Failed" error.
                    </div>
                    <ul>
                        <li><strong>No Password:</strong> Connection is direct but not encrypted by you.</li>
                        <li><strong>With Password:</strong> Click the lock <i data-lucide="lock" class="w-3 h-3 inline text-yellow-500"></i> to enable <strong>AES-256</strong> encryption.</li>
                    </ul>
                    <h4>üõ†Ô∏è Quick Guide</h4>
                    <ol>
                        <li>Click <strong>"Activate"</strong>.</li>
                        <li>Share your ID (or QR Code) with your friend.</li>
                        <li>Connect.</li>
                    </ol>
                    <button onclick="closeModals()" class="mt-8 bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-emerald-500 w-full shadow-lg">Got it!</button>
                </div>

            </div>
        </div>

        <!-- Header -->
        <div class="p-4 md:p-6 p2p-header flex justify-between items-center sticky top-0 z-10">
            <div>
                <h2 class="text-lg md:text-xl font-bold flex items-center gap-2 p2p-text-main">
                    <i data-lucide="network" class="text-emerald-500 w-5 h-5"></i>
                    <span data-lang="title">Transfert P2P</span>
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <!-- BOUTON LANGUE PRINCIPAL -->
                <button onclick="toggleLanguage()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted transition-colors flex items-center gap-1" title="Changer langue">
                    <i data-lucide="languages" class="w-5 h-5"></i>
                    <span id="current-lang-display" class="text-xs font-bold">FR</span>
                </button>

                <button onclick="openHelp()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted transition-colors" title="Aide">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
                
                <button onclick="forceStop()" class="p-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-colors" title="Forcer l'arr√™t">
                    <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                </button>
                
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-slate-500/10 hover:bg-slate-500/20 p2p-text-muted transition-colors" title="Th√®me">
                    <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
                
                <div id="status-badge" class="hidden md:flex px-3 py-1.5 rounded-full text-xs font-bold border items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> D√©connect√©
                </div>
            </div>
        </div>

        <!-- Contenu -->
        <div class="p-4 md:p-6 space-y-6 p2p-bg-main">
            
            <!-- ZONE IDENTIT√â -->
            <div id="section-identity" class="space-y-4 fade-in">
                <label class="flex items-center gap-2 cursor-pointer w-fit text-sm p2p-text-muted">
                    <input type="checkbox" id="use-custom-name" class="w-4 h-4 accent-emerald-500 rounded" onchange="toggleCustomName()">
                    <span data-lang="useSecretName">Choisir mon nom</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="my-id-input" disabled placeholder="ID Al√©atoire..." class="w-full rounded-xl px-4 py-3 p2p-input text-sm" data-lang-placeholder="idPlaceholder">
                    <button onclick="initializePeer()" id="btn-init" class="px-4 md:px-6 py-3 rounded-xl font-bold bg-emerald-600 hover:bg-emerald-500 text-white flex items-center gap-2 shadow-lg whitespace-nowrap">
                        <i data-lucide="power" class="w-4 h-4"></i> <span data-lang="activate">Activer</span>
                    </button>
                </div>
                <div id="id-error" class="hidden text-sm text-red-400 p-3 bg-red-500/10 border border-red-500/20 rounded-lg"></div>
            </div>

            <!-- ZONE CONNEXION -->
            <div id="section-connect" class="hidden space-y-6 pt-2 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    
                    <!-- Bloc Rejoindre -->
                    <div class="p-4 md:p-5 rounded-xl p2p-bg-card border p2p-border shadow-sm">
                        <h3 class="text-xs font-bold text-blue-500 mb-3 uppercase flex items-center gap-2">
                            <i data-lucide="log-in" class="w-4 h-4"></i> <span data-lang="joinSomeone">Rejoindre</span>
                        </h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="remote-id-input" class="w-full rounded-lg px-3 py-2 text-sm p2p-input" placeholder="ID de l'ami" data-lang-placeholder="remoteIdPlaceholder">
                            <button onclick="startScanner()" class="p-2 bg-slate-500/20 hover:bg-slate-500/30 rounded-lg text-slate-300 transition-colors" title="Scanner QR Code">
                                <i data-lucide="scan-line" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <button onclick="connectToPeer()" id="btn-connect" class="w-full bg-blue-600 hover:bg-blue-500 py-2.5 rounded-lg text-sm font-bold text-white shadow-lg transition-transform active:scale-95">
                            <span data-lang="connect">Connexion</span>
                        </button>
                    </div>

                    <!-- Bloc Mon ID -->
                    <div class="p-4 md:p-5 rounded-xl p2p-bg-card border p2p-border shadow-sm">
                        <h3 class="text-xs font-bold text-emerald-500 mb-3 uppercase flex items-center gap-2">
                            <i data-lucide="fingerprint" class="w-4 h-4"></i> <span data-lang="yourId">Mon ID</span>
                        </h3>
                        <div class="flex items-center justify-between p2p-input p-2 rounded-lg border-dashed border p2p-border mb-2">
                            <code id="display-my-id" class="font-mono text-lg text-emerald-500 truncate blur-text mr-2 flex-grow select-none">...</code>
                            <div class="flex items-center gap-1 pl-2 border-l border-slate-500/20">
                                <button onclick="toggleIdReveal()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i id="eye-icon" data-lucide="eye" class="w-4 h-4"></i></button>
                                <button onclick="showQrCode()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i data-lucide="qr-code" class="w-4 h-4"></i></button>
                                <button onclick="copyId()" class="p-1.5 hover:bg-slate-500/20 rounded p2p-text-muted"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <p class="text-[10px] p2p-text-muted"><span data-lang="shareIdInstruction">Partagez ceci pour qu'on vous rejoigne.</span></p>
                    </div>
                </div>
            </div>

            <!-- ZONE PARTAGE (CHAT & FICHIERS) -->
            <div id="section-sharing" class="hidden pt-2 fade-in">
                
                <!-- Info Barre avec Cadenas -->
                <div class="flex justify-between items-center mb-4 p-2 rounded-lg bg-slate-500/5 border border-slate-500/10">
                    <div class="text-xs font-bold text-emerald-500 flex items-center gap-2 pl-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span id="connected-peer-name">...</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <!-- Bouton Password -->
                        <button onclick="openPasswordModal()" id="btn-lock" class="p-2 rounded-lg hover:bg-slate-500/20 text-slate-400 transition-colors" title="D√©finir un mot de passe">
                            <i data-lucide="lock" class="w-4 h-4"></i>
                        </button>
                        <div class="w-px h-4 bg-slate-500/20"></div>
                        <button onclick="document.getElementById('file-input-chat').click()" class="p-2 rounded-lg hover:bg-slate-500/20 p2p-text-muted" title="Envoyer Fichier">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <input type="file" id="file-input-chat" class="hidden" multiple onchange="handleFileSelect(this)">
                    </div>
                </div>

                <!-- Interface Chat (Style Messagerie) -->
                <div class="chat-interface p2p-bg-card rounded-xl border p2p-border overflow-hidden shadow-lg">
                    
                    <!-- Zone des messages (Scrollable) -->
                    <div id="chat-log" class="chat-log-area p2p-bg-main">
                        <div class="msg-info flex flex-col gap-1">
                            <span data-lang="connectedMsg">Connexion √©tablie.</span>
                            <!-- STATUT DE S√âCURIT√â DYNAMIQUE -->
                            <span id="security-status" class="text-[10px] text-amber-500"></span>
                        </div>
                    </div>

                    <!-- Zone de saisie (Fixe en bas) -->
                    <div class="chat-input-area p2p-header flex gap-2 items-center">
                        <input type="text" id="msg-input" class="flex-grow rounded-full px-4 py-2.5 text-sm p2p-input border-none focus:ring-2 focus:ring-emerald-500 shadow-inner" placeholder="Message..." data-lang-placeholder="chatPlaceholder" onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="p-2.5 rounded-full bg-emerald-600 text-white hover:bg-emerald-500 transition-transform active:scale-90 shadow-md">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Preview Fichier -->
                <div id="file-preview-area" class="hidden mt-2 p-2 bg-slate-500/10 rounded text-xs p2p-text-muted flex justify-between items-center">
                    <span id="file-preview-name">Fichier s√©lectionn√©</span>
                    <button onclick="sendFiles()" class="text-emerald-500 font-bold hover:underline">Envoyer</button>
                </div>
                
                <div id="zip-loading" class="hidden text-center text-[10px] text-emerald-500 mt-1">Envoi en cours...</div>
            </div>

        </div>
    </div>

    <script>
        // --- Init ---
        let peer = null, conn = null, myId = null, filesToProcess = [];
        let html5QrCode = null;
        let isScannerRunning = false; 
        let isDark = true;
        let sharedPassword = ""; 
        let currentLang = 'fr';

        // --- Traductions Compl√®tes ---
        const UI_TRANSLATIONS = {
            fr: {
                title: "Transfert P2P",
                useSecretName: "Choisir mon nom",
                activate: "Activer",
                joinSomeone: "Rejoindre",
                connect: "Connexion",
                yourId: "Mon ID",
                shareIdInstruction: "Partagez ceci pour qu'on vous rejoigne.",
                helpTitle: "Comment √ßa marche ?",
                idPlaceholder: "ID Al√©atoire...",
                remoteIdPlaceholder: "ID de l'ami",
                statusDisconnected: "D√©connect√©",
                statusOnline: "En ligne (Pr√™t)",
                statusConnected: "Connect√©",
                statusWaiting: "En ligne",
                idTakenError: "Ce nom est d√©j√† pris !",
                connectedMsg: "Connexion √©tablie.",
                toastCopied: "Copi√© !",
                // Nouveaux ajouts v12
                chatPlaceholder: "Message...",
                passwordModalTitle: "Mot de passe (Secret partag√©)",
                goldenRule: "R√àGLE D'OR :",
                goldenRuleText: "Vous et votre ami devez entrer EXACTEMENT le m√™me mot de passe.",
                passwordMismatchInfo: "Si les mots de passe sont diff√©rents, les messages appara√Ætront comme 'Ind√©chiffrables'.",
                passwordInputPlaceholder: "Mot de passe commun...",
                enableEncryption: "Activer le chiffrement",
                securityEncrypted: "üîí Chiffr√© (Mot de passe actif)",
                securityUnencrypted: "‚ö†Ô∏è Non chiffr√© (Pas de mot de passe)",
                decryptionFail: "üö´ √âchec : Mots de passe diff√©rents",
                dataCorrupt: "üö´ √âchec : Donn√©es corrompues ou Mots de passe diff√©rents",
                encryptedMsgReceived: "üîí Message chiffr√© re√ßu. Veuillez d√©finir le mot de passe.",
                fileReceived: "Fichier re√ßu : ",
                fileSent: "Fichiers envoy√©s",
            },
            en: {
                title: "P2P Transfer",
                useSecretName: "Choose my name",
                activate: "Activate",
                joinSomeone: "Join",
                connect: "Connect",
                yourId: "My ID",
                shareIdInstruction: "Share this to let others join.",
                helpTitle: "How it works?",
                idPlaceholder: "Random ID...",
                remoteIdPlaceholder: "Friend's ID",
                statusDisconnected: "Disconnected",
                statusOnline: "Online (Ready)",
                statusConnected: "Connected",
                statusWaiting: "Online",
                idTakenError: "This name is already taken!",
                connectedMsg: "Connection established.",
                toastCopied: "Copied!",
                // New additions v12
                chatPlaceholder: "Message...",
                passwordModalTitle: "Password (Shared Secret)",
                goldenRule: "GOLDEN RULE:",
                goldenRuleText: "You and your friend MUST enter EXACTLY the same password.",
                passwordMismatchInfo: "If passwords differ, messages will appear as 'Undecipherable'.",
                passwordInputPlaceholder: "Shared password...",
                enableEncryption: "Enable Encryption",
                securityEncrypted: "üîí Encrypted (Password active)",
                securityUnencrypted: "‚ö†Ô∏è Not Encrypted (No password)",
                decryptionFail: "üö´ Failed: Different passwords",
                dataCorrupt: "üö´ Failed: Corrupt data or Different passwords",
                encryptedMsgReceived: "üîí Encrypted message received. Please set password.",
                fileReceived: "File received: ",
                fileSent: "Files sent",
            }
        };

        function initUI() {
            updateTheme(true);
            lucide.createIcons();
            updateStatusBadge('disconnect');
            updateSecurityStatusDisplay(); // Initial call
            applyLanguage(currentLang);
        }

        // --- Themes & UI ---
        function updateTheme(forceDark = null) {
            const root = document.getElementById('p2p-root');
            const icon = document.getElementById('theme-icon');
            if (forceDark !== null) isDark = forceDark; else isDark = !isDark;
            
            if (isDark) { root.classList.add('theme-dark'); root.classList.remove('theme-light'); icon.setAttribute('data-lucide', 'moon'); }
            else { root.classList.add('theme-light'); root.classList.remove('theme-dark'); icon.setAttribute('data-lucide', 'sun'); }
            lucide.createIcons();
        }
        function toggleTheme() { updateTheme(); }

        // --- Language System ---
        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            applyLanguage(currentLang);
        }

        function applyLanguage(lang) {
            // Update text content
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (UI_TRANSLATIONS[lang][key]) el.textContent = UI_TRANSLATIONS[lang][key];
            });
            // Update placeholders
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (UI_TRANSLATIONS[lang][key]) el.placeholder = UI_TRANSLATIONS[lang][key];
            });
            
            // Update Help Modal Visibility
            document.getElementById('help-fr').style.display = lang === 'fr' ? 'block' : 'none';
            document.getElementById('help-en').style.display = lang === 'en' ? 'block' : 'none';
            
            // Update Header Button Text
            const langDisplay = document.getElementById('current-lang-display');
            if(langDisplay) langDisplay.textContent = lang.toUpperCase();

            // Update dynamic security status text
            updateSecurityStatusDisplay();
        }

        function updateStatusBadge(state) {
            const b = document.getElementById('status-badge');
            if(!b) return;
            b.innerHTML = ''; 
            
            const t = UI_TRANSLATIONS[currentLang];
            
            if(state === 'connect') b.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> ${t.statusConnected}`;
            else if(state === 'waiting') b.innerHTML = `<span class="w-2 h-2 rounded-full bg-yellow-500"></span> ${t.statusWaiting}`;
            else b.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> ${t.statusDisconnected}`;
        }

        function updateSecurityStatusDisplay() {
            const statusEl = document.getElementById('security-status');
            if (!statusEl) return;
            
            const t = UI_TRANSLATIONS[currentLang];
            
            if (sharedPassword) {
                statusEl.innerHTML = `<i data-lucide="lock" class="w-3 h-3 inline"></i> ${t.securityEncrypted}`;
                statusEl.className = "text-[10px] text-emerald-500";
            } else {
                statusEl.innerHTML = `${t.securityUnencrypted}`;
                statusEl.className = "text-[10px] text-amber-500";
            }
            lucide.createIcons();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('toast-visible');
            setTimeout(() => t.classList.remove('toast-visible'), 2500);
        }

        function forceStop() { if(confirm("Recharger la page ?")) location.reload(); }
        
        // --- Fallback Copy ---
        function secureCopy(text, successMsg = "Copi√© !") {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast(successMsg)).catch(() => fallbackCopy(text, successMsg));
            } else { fallbackCopy(text, successMsg); }
        }

        function fallbackCopy(text, successMsg) {
            const ta = document.createElement("textarea");
            ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { if(document.execCommand('copy')) showToast(successMsg); } catch (err) {}
            document.body.removeChild(ta);
        }

        // --- Modals & Password ---
        function openHelp() { 
            document.getElementById('help-modal').style.display = 'flex'; 
            applyLanguage(currentLang); 
        }
        function openPasswordModal() { 
            document.getElementById('password-modal').style.display = 'flex'; 
            document.getElementById('modal-pw-input').value = sharedPassword;
            document.getElementById('modal-pw-input').focus();
        }
        
        function savePassword() {
            sharedPassword = document.getElementById('modal-pw-input').value.trim();
            const lockBtn = document.getElementById('btn-lock');
            
            if (sharedPassword) {
                lockBtn.classList.remove('text-slate-400');
                lockBtn.classList.add('text-emerald-500');
                showToast("Mot de passe d√©fini !");
            } else {
                lockBtn.classList.add('text-slate-400');
                lockBtn.classList.remove('text-emerald-500');
                showToast("Mot de passe retir√©");
            }
            updateSecurityStatusDisplay();
            closeModals();
        }
        
        function closeModals(e) {
            if (e && e.target.classList.contains('modal-content')) return;
            document.querySelectorAll('.modal-backdrop').forEach(el => el.style.display = 'none');
            if (html5QrCode && isScannerRunning) {
                html5QrCode.stop().then(() => { isScannerRunning = false; html5QrCode.clear(); }).catch(() => { isScannerRunning = false; });
            }
        }

        // --- QR Code Logic ---
        function showQrCode() {
            const id = document.getElementById('display-my-id').innerText;
            if(id === '...' || !id) return;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: id, width: 160, height: 160, colorDark : "#000000", colorLight : "#ffffff" });
            document.getElementById('qr-text-display').textContent = id;
            document.getElementById('qr-modal').style.display = 'flex';
        }

        function startScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
                document.getElementById('remote-id-input').value = decodedText;
                showToast("QR Code d√©tect√© !");
                stopScanner(); 
            }).then(() => { isScannerRunning = true; }).catch(err => { alert("Erreur cam√©ra: " + err); closeModals(); });
        }
        
        function stopScanner() { closeModals(); }

        // --- PeerJS ---
        function initializePeer() {
            const btn = document.getElementById('btn-init');
            if (typeof Peer === 'undefined') { alert("Erreur: PeerJS bloqu√© par le r√©seau."); return; }
            const custom = document.getElementById('use-custom-name').checked ? document.getElementById('my-id-input').value.trim() : null;
            
            btn.disabled = true; btn.innerHTML = `<i data-lucide="loader" class="animate-spin"></i>`; lucide.createIcons();

            peer = new Peer(custom, { debug: 1, config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('display-my-id').innerText = id;
                document.getElementById('section-identity').classList.add('hidden');
                document.getElementById('section-connect').classList.remove('hidden');
                updateStatusBadge('waiting');
                btn.innerHTML = `Activer`;
            });

            peer.on('connection', (c) => setupConn(c));
            peer.on('error', (err) => {
                btn.disabled = false; btn.innerHTML = `Activer`;
                document.getElementById('id-error').classList.remove('hidden');
                // Traduction de l'erreur sp√©cifique
                if (err.type === 'unavailable-id') {
                    document.getElementById('id-error').innerText = UI_TRANSLATIONS[currentLang].idTakenError;
                } else {
                    document.getElementById('id-error').innerText = `Erreur: ${err.type}`;
                }
            });
        }

        function connectToPeer() {
            const target = document.getElementById('remote-id-input').value.trim();
            if(!target) return;
            const btn = document.getElementById('btn-connect');
            btn.innerText = "Connexion..."; btn.disabled = true;
            const c = peer.connect(target);
            setupConn(c);
            setTimeout(() => { if(!conn || !conn.open) { btn.innerText = "R√©essayer"; btn.disabled = false; } }, 5000);
        }

        function setupConn(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('section-connect').classList.add('hidden');
                document.getElementById('section-sharing').classList.remove('hidden');
                document.getElementById('connected-peer-name').innerText = conn.peer;
                updateStatusBadge('connect');
            });
            conn.on('data', (d) => receiveData(d));
            conn.on('close', () => { alert("D√©connect√©"); location.reload(); });
        }

        // --- Messaging & Encryption ---
        function sendMessage() {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if(!txt) return;
            
            const payloadObj = { type: 'text', content: txt };
            let dataToSend = JSON.stringify(payloadObj);
            let isEncrypted = false;

            if (sharedPassword) {
                dataToSend = CryptoJS.AES.encrypt(dataToSend, sharedPassword).toString();
                isEncrypted = true;
            }
            
            if(conn && conn.open) {
                conn.send({ data: dataToSend, encrypted: isEncrypted }); 
                addMsg(txt, 'sent');
                inp.value = '';
            }
        }

        function receiveData(packet) {
            let raw = packet.data;
            
            if (packet.encrypted) {
                if (!sharedPassword) {
                    addMsg(UI_TRANSLATIONS[currentLang].encryptedMsgReceived, 'info');
                    return;
                }
                try {
                    const bytes = CryptoJS.AES.decrypt(raw, sharedPassword);
                    raw = bytes.toString(CryptoJS.enc.Utf8);
                    if(!raw) throw new Error("Decryption failed / Empty");
                } catch(e) {
                    addMsg(UI_TRANSLATIONS[currentLang].decryptionFail, 'error');
                    return;
                }
            }
            
            if(!raw) return;

            try {
                const p = JSON.parse(raw);
                if(p.type === 'text') addMsg(p.content, 'received');
                if(p.type === 'file') {
                    // CORRECTIF S√âCURIT√â (XSS Patch)
                    // Cr√©ation s√©curis√©e de l'√©l√©ment via l'API DOM pour √©viter l'injection de code
                    const a = document.createElement('a');
                    a.href = `data:${p.mime};base64,${p.content}`;
                    a.download = p.name; // Le navigateur traite ceci comme du texte brut
                    a.className = "underline font-bold";
                    a.textContent = `üì• ${p.name}`; 
                    
                    // On passe le HTML s√©curis√© (outerHTML)
                    addMsg(a.outerHTML, 'received', true);
                }
            } catch(e) {
                addMsg(UI_TRANSLATIONS[currentLang].dataCorrupt, 'error');
            }
        }

        function addMsg(content, type, isHtml = false) {
            const log = document.getElementById('chat-log');
            const d = document.createElement('div');
            if (type === 'info') {
                d.className = "msg-info";
                d.innerText = content;
            } else if (type === 'error') {
                d.className = "msg-error";
                d.innerText = content;
            } else {
                d.className = `msg-bubble ${type === 'sent' ? 'msg-sent' : 'msg-received'}`;
                if(isHtml) d.innerHTML = content; else d.innerText = content;
                if(!isHtml) d.onclick = () => { secureCopy(d.innerText, UI_TRANSLATIONS[currentLang].toastCopied); };
            }
            log.appendChild(d);
            log.scrollTop = log.scrollHeight;
        }

        // --- Files ---
        function handleFileSelect(input) {
            filesToProcess = [...input.files];
            if(filesToProcess.length > 0) {
                document.getElementById('file-preview-area').classList.remove('hidden');
                document.getElementById('file-preview-name').innerText = `${filesToProcess.length} fichier(s) pr√™t(s)`;
            }
        }

        async function sendFiles() {
            if(filesToProcess.length === 0) return;
            document.getElementById('zip-loading').classList.remove('hidden');
            document.getElementById('file-preview-area').classList.add('hidden');
            
            try {
                const zip = new JSZip();
                for(let f of filesToProcess) zip.file(f.name, f);
                const content = await zip.generateAsync({type:"base64"});
                
                const payloadObj = { type: 'file', name: `Files.zip`, content: content, mime: 'application/zip' };
                let dataToSend = JSON.stringify(payloadObj);
                let isEncrypted = false;

                if (sharedPassword) {
                    dataToSend = CryptoJS.AES.encrypt(dataToSend, sharedPassword).toString();
                    isEncrypted = true;
                }

                conn.send({ data: dataToSend, encrypted: isEncrypted });
                addMsg(UI_TRANSLATIONS[currentLang].fileSent, 'sent');
            } catch(e) { alert(e); }
            
            document.getElementById('zip-loading').classList.add('hidden');
            filesToProcess = [];
        }

        // Helpers
        function toggleCustomName() {
            const chk = document.getElementById('use-custom-name');
            const inp = document.getElementById('my-id-input');
            inp.disabled = !chk.checked;
            if(!chk.checked) inp.value = ''; else inp.focus();
        }
        function toggleIdReveal() {
            document.getElementById('display-my-id').classList.toggle('revealed');
            lucide.createIcons();
        }
        function copyId() {
            const txt = document.getElementById('display-my-id').innerText;
            if(txt !== '...') secureCopy(txt, UI_TRANSLATIONS[currentLang].toastCopied);
        }

        initUI();
    </script>
</body>
</html>
